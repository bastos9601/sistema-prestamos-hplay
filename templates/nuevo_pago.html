{% extends "base.html" %}

{% block title %}Nuevo Pago - Sistema de Préstamos{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus me-2"></i>
                    Nuevo Pago
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.csrf_token }}
                    
                    <div class="mb-3">
                        <label for="{{ form.prestamo_id.id }}" class="form-label">
                            <i class="fas fa-money-bill-wave me-1"></i>Préstamo *
                        </label>
                        <select id="{{ form.prestamo_id.id }}" name="{{ form.prestamo_id.name }}" class="form-select" required>
                            <option value="">Seleccione un préstamo</option>
                            {% for item in prestamos %}
                            <option value="{{ item.prestamo.id }}" 
                                    data-cliente="{{ item.cliente.nombre }} {{ item.cliente.apellido }}"
                                    data-monto="{{ item.prestamo.monto }}"
                                    data-tasa="{{ item.prestamo.tasa_interes }}"
                                    data-plazo="{{ item.prestamo.plazo_dias }}">
                                Préstamo #{{ item.prestamo.id }} - {{ item.cliente.nombre }} {{ item.cliente.apellido }} 
                                (${{ "%.2f"|format(item.prestamo.monto) }})
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.prestamo_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.prestamo_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.monto.id }}" class="form-label">
                            <i class="fas fa-dollar-sign me-1"></i>Monto del Pago *
                        </label>
                        {{ form.monto(class="form-control", placeholder="0.00", step="0.01", min="0.01") }}
                        {% if form.monto.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.monto.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.concepto.id }}" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Concepto del Pago
                        </label>
                        {{ form.concepto(class="form-control", placeholder="Ej: Pago de cuota diaria", rows="3") }}
                        {% if form.concepto.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.concepto.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Describe el motivo del pago (opcional)</div>
                    </div>
                    
                    <!-- Información del préstamo seleccionado -->
                    <div id="prestamoInfo" class="alert alert-info" style="display: none;">
                        <h6><i class="fas fa-info-circle me-1"></i>Información del Préstamo</h6>
                        <div id="prestamoDetails"></div>
                    </div>
                    
                    <!-- Cálculo de cuota sugerida -->
                    <div id="cuotaSugerida" class="alert alert-warning" style="display: none;">
                        <h6><i class="fas fa-calculator me-1"></i>Cuota Sugerida</h6>
                        <div id="cuotaDetails"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('pagos') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Volver
                        </a>
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-save me-1"></i>Registrar Pago
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const prestamoSelect = document.getElementById('{{ form.prestamo_id.id }}');
    const montoInput = document.getElementById('{{ form.monto.id }}');
    const prestamoInfo = document.getElementById('prestamoInfo');
    const prestamoDetails = document.getElementById('prestamoDetails');
    const cuotaSugerida = document.getElementById('cuotaSugerida');
    const cuotaDetails = document.getElementById('cuotaDetails');
    
    // Mostrar información del préstamo seleccionado
    prestamoSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (this.value) {
            const cliente = selectedOption.dataset.cliente;
            const monto = parseFloat(selectedOption.dataset.monto);
            const tasa = parseFloat(selectedOption.dataset.tasa);
            const plazo = parseInt(selectedOption.dataset.plazo);
            
            prestamoDetails.innerHTML = `
                <strong>Cliente:</strong> ${cliente}<br>
                <strong>Monto del Préstamo:</strong> $${monto.toFixed(2)}<br>
                <strong>Tasa de Interés:</strong> ${tasa}% anual<br>
                <strong>Plazo:</strong> ${plazo} días
            `;
            prestamoInfo.style.display = 'block';
            
            // Calcular cuota sugerida
            calcularCuotaSugerida(monto, tasa, plazo);
        } else {
            prestamoInfo.style.display = 'none';
            cuotaSugerida.style.display = 'none';
        }
    });
    
    // Calcular cuota sugerida
    function calcularCuotaSugerida(monto, tasa, plazo) {
        if (monto > 0 && tasa > 0 && plazo > 0) {
            const tasaDiaria = tasa / 365 / 100;
            const cuotaDiaria = monto * tasaDiaria;
            
            cuotaDetails.innerHTML = `
                <strong>Cuota Diaria Sugerida:</strong> $${cuotaDiaria.toFixed(2)}<br>
                <small class="text-muted">Basado en el monto, tasa y plazo del préstamo</small>
            `;
            cuotaSugerida.style.display = 'block';
            
            // Sugerir monto del pago
            montoInput.placeholder = cuotaDiaria.toFixed(2);
        } else {
            cuotaSugerida.style.display = 'none';
        }
    }
    
    // Validación en tiempo real
    montoInput.addEventListener('input', function() {
        if (this.value <= 0) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        }
    });
    
    // Pre-llenar monto si viene de URL
    const urlParams = new URLSearchParams(window.location.search);
    const prestamoId = urlParams.get('prestamo_id');
    if (prestamoId) {
        prestamoSelect.value = prestamoId;
        prestamoSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
